<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>梓樂Nagoya v60.7 (Bus Return Added)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3.4.19/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&family=Shippori+Mincho:wght@600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-main: #70808f; --bg-card: #c5b59d; --text-on-card: #4a4238; --text-on-bg: #f3f0eb; }
        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: var(--bg-main); color: var(--text-on-bg); margin: 0; padding: 0; height: 100dvh; width: 100vw; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .font-mincho { font-family: 'Shippori Mincho', serif; }
        .glass { background: var(--bg-card); color: var(--text-on-card); border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-top { padding-top: max(20px, env(safe-area-inset-top)); }
        .safe-bottom { padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        input { user-select: text !important; pointer-events: auto !important; }
        .modal-layer { position: fixed; inset: 0; z-index: 99999; }
        .modal-content { position: relative; z-index: 100000; }
        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .calc-btn { background: rgba(255, 255, 255, 0.2); border-radius: 12px; height: 50px; font-weight: 800; color: #4a4238; display: flex; align-items: center; justify-content: center; }
        .calc-btn:active { background: rgba(255, 255, 255, 0.4); transform: scale(0.95); }
        .ticket-stub { clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 70%, 5% 65%, 0% 60%, 0% 0%); cursor: pointer; transition: transform 0.1s; }
        .ticket-stub:active { transform: scale(0.98); }
        .method-online { background: #e6f4ea; color: #1e4620; border-left: 4px solid #34a853; }
        .method-onsite { background: #fef7e0; color: #5f370e; border-left: 4px solid #fbbc04; }
        .method-mobile { background: #f1f3f4; color: #3c4043; border-left: 4px solid #9aa0a6; }
        .sync-status { position: fixed; top: 10px; right: 10px; z-index: 9999; font-size: 10px; font-weight: bold; padding: 4px 8px; border-radius: 20px; background: rgba(0,0,0,0.5); color: white; display: flex; items-center; gap: 5px; }
        #app-error { display: none; padding: 20px; color: white; text-align: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #70808f; z-index: 999999; }
        [v-cloak] { display: none !important; }
    </style>
</head>
<body>

<div id="app-error">
    <h2 class="text-xl font-bold mt-10">⚠️ App Error</h2>
    <p id="error-msg" class="text-sm mt-2 opacity-80 font-mono p-4">Loading...</p>
    <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-white/20 rounded-lg">Reload</button>
</div>

<div id="app" v-cloak class="flex flex-col h-full w-full max-w-md mx-auto relative bg-[#70808f]">
    
    <div class="sync-status" v-if="syncStatus">
        <div class="w-2 h-2 rounded-full" :class="syncColor"></div>
        {{ syncStatus }}
    </div>

    <main v-show="!isModalOpen" class="flex-1 overflow-y-auto no-scrollbar z-10 pb-28 pt-safe-top px-5 scroll-smooth relative">
        
        <div v-if="currentView === 'itinerary'" class="space-y-5 pb-4">
            <div class="flex justify-between items-center mb-2 mt-2">
                <div><div class="text-[10px] font-bold text-white/80 uppercase tracking-widest">JP.TRIP 2026</div><h1 class="text-3xl font-black font-mincho text-white flex items-center gap-2"><i class="fas fa-chess-rook text-xl opacity-80"></i> 梓樂Nagoya</h1></div>
                <div class="w-10 h-10 rounded-full border-2 border-white/50 overflow-hidden shadow-lg bg-[#c5b59d]"><img src="icon.jpg" class="w-full h-full object-cover" onerror="this.style.display='none'"></div>
            </div>
            
            <div class="glass p-5 relative overflow-hidden mb-2 shadow-xl">
                <div class="flex justify-between items-end mb-2"><span class="text-xs font-bold opacity-60 uppercase tracking-wider">距離出發 (HKO)</span><i class="fas fa-plane text-[#726251] animate-pulse"></i></div>
                <div class="flex items-baseline gap-2 mb-4">
                    <span class="text-5xl font-black font-mono tracking-tighter">{{ countdown.days }}</span><span class="text-xs font-bold opacity-80 mr-2">days</span>
                    <span class="text-xl font-mono font-bold">{{ countdown.hours }}</span><span class="text-[10px] opacity-60 mr-1">h</span>
                    <span class="text-xl font-mono font-bold">{{ countdown.minutes }}</span><span class="text-[10px] opacity-60 mr-1">m</span>
                    <span class="text-xl font-mono font-bold">{{ countdown.seconds }}</span><span class="text-[10px] opacity-60">s</span>
                </div>
                <div class="relative w-full h-2 bg-[#4a4238]/10 rounded-full mt-2"><div class="absolute top-0 left-0 h-full bg-[#726251] rounded-full transition-all duration-1000" :style="{ width: tripProgress + '%' }"></div></div>
            </div>

            <div class="bg-[#70808f] sticky top-0 z-30 py-2 -mx-5 px-5 border-b border-[#c5b59d]/30 shadow-lg">
                <div class="flex gap-3 overflow-x-auto no-scrollbar">
                    <button v-for="(day, idx) in itinerary" :key="idx" @click="dayIndex = idx" class="flex-shrink-0 w-12 h-14 rounded-xl flex flex-col items-center justify-center border transition-all cursor-pointer active:scale-95" :class="dayIndex === idx ? 'bg-[#c5b59d] text-[#4a4238] border-[#c5b59d] shadow-lg scale-105' : 'bg-white/10 border-white/10 text-white/60'">
                        <span class="text-[9px] font-bold uppercase">{{ day.date_en.substr(0,3) }}</span>
                        <span class="text-lg font-black">{{ day.date_short.split('/')[1] }}</span>
                    </button>
                </div>
            </div>

            <div class="glass p-3 border-l-4 border-[#726251] flex items-center justify-between">
                <div class="flex flex-col"><span class="text-[10px] font-bold opacity-60 uppercase tracking-wider">{{ itinerary[dayIndex].date_short }} Weather</span><span class="text-xs font-bold">{{ itinerary[dayIndex].location }}</span></div>
                <div class="flex gap-3 overflow-x-auto no-scrollbar max-w-[65%]"><div v-for="(h, i) in currentDayWeather" :key="i" class="flex flex-col items-center min-w-[2.5rem]"><span class="text-[9px] opacity-60 font-mono">{{ h.time }}</span><i :class="h.icon" class="text-sm my-0.5"></i><span class="text-[10px] font-bold">{{ h.temp }}</span></div></div>
            </div>
            <div class="relative pl-2">
                <div class="absolute left-[7px] top-2 bottom-0 w-[2px] bg-[#c5b59d]/30 rounded-full"></div>
                <div v-for="(place, pIdx) in itinerary[dayIndex].places" :key="pIdx" class="relative pl-8 mb-6 group">
                    <div class="absolute left-0 top-0 w-4 h-4 bg-[#c5b59d] border-[3px] border-[#70808f] rounded-full z-10" :class="getTypeColor(place.type)"></div>
                    <div @click="openDetail(place)" class="glass p-4 relative overflow-hidden active:scale-[0.98] transition-all cursor-pointer hover:bg-[#d6c9b5] z-10">
                        <div class="flex justify-between items-start mb-2 relative z-10"><span class="text-[10px] font-black bg-[#70808f] text-white px-2 py-1 rounded">{{ place.time }}</span><span class="text-[10px] font-bold opacity-60 uppercase">{{ place.typeLabel }}</span></div>
                        <h3 class="text-lg font-black mb-1 relative z-10">{{ place.name }}</h3><p class="text-xs opacity-80 line-clamp-1 mb-2 relative z-10">{{ place.desc }}</p>
                        <div class="flex flex-wrap gap-2 mt-2 relative z-10"><span v-for="tag in place.highlights" class="px-2 py-1 bg-white/50 border border-black/5 rounded text-[10px] font-bold text-[#726251]">{{ tag }}</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'wallet'" class="space-y-6 pt-4">
            <h2 class="text-2xl font-black font-mincho text-white">Spend & Buy</h2>
            <div class="flex bg-white/10 p-1 rounded-xl"><button @click="walletMode='expense'" class="flex-1 py-3 rounded-lg text-xs font-bold transition-all" :class="walletMode==='expense'?'bg-[#c5b59d] text-[#4a4238] shadow-sm':'text-white/60'">記帳</button><button @click="walletMode='wishlist'" class="flex-1 py-3 rounded-lg text-xs font-bold transition-all" :class="walletMode==='wishlist'?'bg-[#c5b59d] text-[#4a4238] shadow-sm':'text-white/60'">購物</button></div>
            
            <div v-if="walletMode==='expense'" class="space-y-4">
                <div class="glass p-5 flex justify-between items-center"><div class="flex flex-col"><span class="text-xs font-bold opacity-60 uppercase mb-1">Total Spent</span><span class="text-3xl font-mono font-black">¥{{ filteredTotal.toLocaleString() }}</span><span class="text-xs font-bold opacity-50 mt-1">≈ HKD ${{ (filteredTotal * currencyRate).toFixed(1) }}</span></div></div>
                <div class="space-y-3 pb-20"><div v-for="(item, idx) in filteredBudgetList" :key="idx" class="glass p-4 flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full flex items-center justify-center text-xs text-white shadow-sm" :class="item.payer==='TszLok'?'bg-[#91867f]':'bg-[#726251]'">{{ item.payer[0] }}</div><span class="text-sm font-bold">{{ item.name }}</span></div><div class="flex flex-col items-end"><span class="font-mono font-bold opacity-80">¥{{ item.price }}</span><span class="text-[9px] font-mono opacity-50">HKD ${{ (item.price * currencyRate).toFixed(1) }}</span></div><button @click="deleteBudget(item)" class="opacity-40 hover:text-red-600 ml-2"><i class="fas fa-times text-xs"></i></button></div></div>
                <div class="fixed bottom-24 right-6 z-40"><button @click="showBudgetInput=true" class="w-14 h-14 bg-[#c5b59d] text-[#4a4238] rounded-full shadow-xl flex items-center justify-center text-xl border-2 border-white/20 active:scale-90 transition-transform"><i class="fas fa-plus"></i></button></div>
            </div>

            <div v-if="walletMode==='wishlist'" class="grid grid-cols-2 gap-4 pb-20">
                <div @click="showWishlistInput=true" class="glass p-4 flex flex-col items-center justify-center aspect-square border-2 border-dashed border-[#4a4238]/20 hover:bg-[#d6c9b5] cursor-pointer opacity-60 hover:opacity-100 transition-opacity"><i class="fas fa-plus text-2xl mb-2"></i><span class="text-xs font-bold">Add Item</span></div>
                <div v-for="(item, idx) in wishlist" :key="idx" class="glass overflow-hidden relative group">
                    <button @click="deleteWishlist(idx)" class="absolute top-2 right-2 w-6 h-6 bg-black/60 rounded-full flex items-center justify-center text-xs z-10 text-white shadow-md"><i class="fas fa-times"></i></button>
                    <img v-if="item.image" :src="item.image" class="w-full aspect-square object-cover">
                    <div v-else class="w-full aspect-square bg-[#4a4238]/10 flex items-center justify-center flex-col p-2 text-center"><i class="fas fa-shopping-bag text-2xl mb-2 opacity-30"></i></div>
                    <div class="p-3"><div class="font-bold text-sm truncate">{{ item.name }}</div><div class="font-mono text-xs font-bold opacity-60">¥{{ item.price }}</div><div class="font-mono text-[9px] font-bold opacity-40">HKD ${{ (item.price * currencyRate).toFixed(1) }}</div></div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'reservations'" class="space-y-6 pt-4">
            <h2 class="text-2xl font-black font-mincho text-white">預約 & 票券 Resv</h2>
            <div class="space-y-3">
                <div class="glass p-0 overflow-hidden relative border-l-4 border-[#91867f]"><div class="bg-[#91867f]/10 p-3 flex justify-between items-center border-b border-[#4a4238]/10"><span class="text-xs font-bold uppercase tracking-widest text-[#91867f]">Outbound</span><span class="text-xs font-bold text-[#4a4238]">2/25 (Wed)</span></div><div class="p-4 flex justify-between items-center"><div class="text-center"><div class="text-2xl font-black font-mono">HKG</div></div><div class="flex flex-col items-center px-4"><i class="fas fa-arrow-right text-[#91867f] mb-1"></i><div class="text-[10px] font-bold bg-[#4a4238] text-white px-2 py-0.5 rounded">UO680</div></div><div class="text-center"><div class="text-2xl font-black font-mono">NGO</div></div></div></div>
                <div class="glass p-0 overflow-hidden relative border-l-4 border-[#726251]"><div class="bg-[#726251]/10 p-3 flex justify-between items-center border-b border-[#4a4238]/10"><span class="text-xs font-bold uppercase tracking-widest text-[#726251]">Inbound</span><span class="text-xs font-bold text-[#4a4238]">3/3 (Tue)</span></div><div class="p-4 flex justify-between items-center"><div class="text-center"><div class="text-2xl font-black font-mono">NGO</div></div><div class="flex flex-col items-center px-4"><i class="fas fa-arrow-right text-[#726251] mb-1"></i><div class="text-[10px] font-bold bg-[#4a4238] text-white px-2 py-0.5 rounded">UO685</div></div><div class="text-center"><div class="text-2xl font-black font-mono">HKG</div></div></div></div>
            </div>
            
            <div><div class="flex items-center gap-2 mb-2 text-white/80"><span class="w-2 h-2 rounded-full bg-[#34a853] shadow-[0_0_10px_#34a853]"></span><h3 class="text-xs font-bold uppercase tracking-widest">現在就買 Online</h3></div><div class="space-y-2"><div v-for="(item, i) in getTicketsByMethod('online')" :key="i" @click="openTicketDetail(item)" class="ticket-stub p-4 rounded-r-xl flex justify-between items-center shadow-md bg-white border-l-4 border-[#34a853]"><div class="flex flex-col"><div class="flex items-center gap-2 mb-1"><span class="text-[10px] font-black uppercase opacity-60 text-[#4a4238]">Day {{ item.date.split('/')[1] }}</span><span class="text-[10px] font-bold bg-black/5 px-1.5 rounded">{{ item.date }}</span></div><div class="font-black text-sm text-[#4a4238] leading-tight">{{ item.title }}</div></div><div class="text-right"><i class="fas fa-chevron-right text-xs opacity-30"></i></div></div></div></div>
            <div><div class="flex items-center gap-2 mb-2 text-white/80"><span class="w-2 h-2 rounded-full bg-[#fbbc04] shadow-[0_0_10px_#fbbc04]"></span><h3 class="text-xs font-bold uppercase tracking-widest">現場購買 Onsite</h3></div><div class="space-y-2"><div v-for="(item, i) in getTicketsByMethod('onsite')" :key="i" @click="openTicketDetail(item)" class="ticket-stub p-4 rounded-r-xl flex justify-between items-center shadow-md bg-white border-l-4 border-[#fbbc04]"><div class="flex flex-col"><div class="flex items-center gap-2 mb-1"><span class="text-[10px] font-black uppercase opacity-60 text-[#4a4238]">Day {{ item.date.split('/')[1] }}</span><span class="text-[10px] font-bold bg-black/5 px-1.5 rounded">{{ item.date }}</span></div><div class="font-black text-sm text-[#4a4238] leading-tight">{{ item.title }}</div></div><div class="text-right"><i class="fas fa-chevron-right text-xs opacity-30"></i></div></div></div></div>
            <div><div class="flex items-center gap-2 mb-2 text-white/80"><span class="w-2 h-2 rounded-full bg-[#9aa0a6] shadow-[0_0_10px_#9aa0a6]"></span><h3 class="text-xs font-bold uppercase tracking-widest">數位支付 Mobile</h3></div><div class="space-y-2"><div v-for="(item, i) in getTicketsByMethod('mobile')" :key="i" @click="openTicketDetail(item)" class="ticket-stub p-4 rounded-r-xl flex justify-between items-center shadow-md bg-white border-l-4 border-[#9aa0a6]"><div class="flex flex-col"><div class="flex items-center gap-2 mb-1"><span class="text-[10px] font-black uppercase opacity-60 text-[#4a4238]">Day {{ item.date.split('/')[1] }}</span><span class="text-[10px] font-bold bg-black/5 px-1.5 rounded">{{ item.date }}</span></div><div class="font-black text-sm text-[#4a4238] leading-tight">{{ item.title }}</div></div><div class="text-right"><i class="fas fa-chevron-right text-xs opacity-30"></i></div></div></div></div>

            <div class="glass p-5 border-t-4 border-red-400 mb-20">
                <h3 class="font-bold text-sm mb-3 flex items-center"><i class="fas fa-clipboard-check mr-2"></i>最終確認清單</h3>
                <div class="space-y-2">
                    <label class="flex items-center gap-3 p-2 bg-black/5 rounded-lg"><input type="checkbox" class="w-4 h-4 accent-[#726251]"><span class="text-xs font-bold">Visit Japan Web QR Code (入境)</span></label>
                    <label class="flex items-center gap-3 p-2 bg-black/5 rounded-lg"><input type="checkbox" class="w-4 h-4 accent-[#726251]"><span class="text-xs font-bold">護照 (有效期 > 6個月)</span></label>
                    <label class="flex items-center gap-3 p-2 bg-black/5 rounded-lg"><input type="checkbox" class="w-4 h-4 accent-[#726251]"><span class="text-xs font-bold">E-SIM / 漫遊已開通</span></label>
                    <label class="flex items-center gap-3 p-2 bg-black/5 rounded-lg"><input type="checkbox" class="w-4 h-4 accent-[#726251]"><span class="text-xs font-bold">現金 ¥30,000 (Day 6+雜支)</span></label>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'packing'" class="space-y-6 pt-4">
            <h2 class="text-2xl font-black font-mincho text-white">行李清單</h2>
            <div v-for="(group, key) in packingList" :key="key" class="glass overflow-hidden"><div class="bg-[#726251]/10 px-5 py-3 flex items-center gap-3 border-b border-[#4a4238]/10"><i class="fas" :class="key==='handCarry'?'fa-briefcase':key==='tszLok'?'fa-male text-[#91867f]':key==='tszTung'?'fa-female text-[#726251]':'fa-box'"></i><span class="font-bold text-sm uppercase tracking-wide">{{ keyLabels[key] }}</span></div><div class="p-2 grid gap-1"><label v-for="(item, idx) in group" :key="idx" class="flex items-center p-3 hover:bg-[#726251]/5 rounded-xl cursor-pointer check-box transition-colors"><input type="checkbox" v-model="item.checked" @change="saveData" class="hidden"><div class="w-5 h-5 rounded border-2 border-[#4a4238]/30 flex items-center justify-center mr-3 transition-colors bg-white/50"><i class="fas fa-check text-[#4a4238] text-[10px] opacity-0" :class="{'opacity-100': item.checked}"></i></div><span class="text-sm font-bold transition-opacity" :class="{'line-through opacity-40': item.checked}">{{ item.name }}</span></label></div></div>
        </div>

        <div v-if="currentView === 'reminders'" class="space-y-6 pt-4">
            <h2 class="text-2xl font-black font-mincho text-white">省錢攻略 Tips</h2>
            <div class="glass overflow-hidden relative"><div class="bg-[#70808f] p-3 text-white flex justify-between items-center border-b border-white/20"><span class="font-bold text-sm"><i class="fas fa-subway mr-2"></i>Day 3 交通</span><span class="bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold">¥760 / 24hr</span></div><div class="p-5"><h3 class="font-bold text-lg mb-2 text-[#4a4238]">地鐵 24 小時券</h3><ul class="text-sm space-y-3 opacity-90 leading-relaxed list-disc pl-4 text-[#4a4238]"><li><b class="text-[#726251]">回本極快：</b>行程總車資約 ¥1,000+，使用此券<span class="font-bold border-b border-[#726251]">現省 ¥300</span>。</li><li><b class="text-[#726251]">彈性極高：</b>採「24小時制」。若 Day 3 早上 10:00 第一次刷卡，可用到 Day 4 早上 09:59。</li></ul></div></div>
            <div class="glass overflow-hidden relative"><div class="bg-[#91867f] p-3 text-white flex justify-between items-center border-b border-white/20"><span class="font-bold text-sm"><i class="fas fa-snowflake mr-2"></i>Day 6 警告</span><span class="bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold">安全第一</span></div><div class="p-5"><h3 class="font-bold text-lg mb-2 text-[#4a4238]">平湯大瀑布 雪地裝備</h3><div class="bg-red-500/10 p-3 rounded-lg mb-3 text-sm font-bold border-l-4 border-red-500 text-red-800">地面極滑！Danger!</div><p class="text-sm opacity-90 text-[#4a4238]">前往瀑布的路段為雪地微上坡，極易結冰滑倒。請務必穿著<b class="text-red-700">防滑鞋 (雪靴)</b> 或加裝簡易冰爪。</p></div></div>
        </div>

        <div v-if="currentView === 'info'" class="space-y-6 pt-4 h-full flex flex-col"><h2 class="text-2xl font-black font-mincho text-white">匯率計算機</h2><div class="glass flex-1 p-5 flex flex-col"><div class="bg-[#f3f0eb] rounded-xl p-4 mb-4 flex-1 flex flex-col justify-end items-end shadow-inner relative overflow-hidden"><div class="text-[#4a4238]/40 font-bold font-mono text-sm mb-1 break-all text-right">{{ calcExpression || '0' }}</div><div class="text-[#4a4238] font-black font-mono text-4xl mb-1 break-all text-right">¥{{ displayValue }}</div><div class="text-[#726251] font-bold font-mono text-2xl flex items-center justify-end w-full">HKD ${{ (parseFloat(displayValue.replace(/,/g,'')) * currencyRate).toFixed(1) }}</div><div class="absolute top-2 left-2 flex items-center gap-1 opacity-40 hover:opacity-100 transition-opacity"><span class="text-[9px] font-bold">Rate:</span><input type="number" v-model="currencyRate" class="w-12 bg-transparent border-b border-[#4a4238]/30 text-[10px] font-mono text-right outline-none"></div></div><div class="calc-grid"><button @click="clearCalc" class="calc-btn op">C</button><button @click="appendCalc('/')" class="calc-btn op">÷</button><button @click="appendCalc('*')" class="calc-btn op">×</button><button @click="backspace" class="calc-btn op">←</button><button @click="appendCalc('7')" class="calc-btn">7</button><button @click="appendCalc('8')" class="calc-btn">8</button><button @click="appendCalc('9')" class="calc-btn">9</button><button @click="appendCalc('-')" class="calc-btn op">-</button><button @click="appendCalc('4')" class="calc-btn">4</button><button @click="appendCalc('5')" class="calc-btn">5</button><button @click="appendCalc('6')" class="calc-btn">6</button><button @click="appendCalc('+')" class="calc-btn op">+</button><button @click="appendCalc('1')" class="calc-btn">1</button><button @click="appendCalc('2')" class="calc-btn">2</button><button @click="appendCalc('3')" class="calc-btn">3</button><button @click="calculate" class="calc-btn eq">=</button><button @click="appendCalc('0')" class="calc-btn col-span-2">0</button><button @click="appendCalc('.')" class="calc-btn">.</button></div></div></div>

    </main>

    <nav v-show="!isModalOpen" class="fixed bottom-0 w-full h-[85px] bg-[#70808f]/95 backdrop-blur-xl border-t border-[#c5b59d]/20 z-50 flex justify-around items-center px-2 pb-safe-bottom">
        <button v-for="tab in tabs" :key="tab.id" @click="currentView = tab.id" class="flex flex-col items-center justify-center w-12 h-full space-y-1 transition-all cursor-pointer active:scale-95" :class="currentView === tab.id ? 'text-[#c5b59d] scale-110' : 'text-white/40'"><i :class="tab.icon" class="text-xl"></i><span class="text-[9px] font-bold uppercase tracking-widest">{{ tab.label }}</span></button>
    </nav>

    <div v-if="showBudgetInput" class="modal-layer flex items-end justify-center"><div class="absolute inset-0 bg-black/80 backdrop-blur-sm" @click="showBudgetInput=false"></div><div class="bg-[#c5b59d] w-full max-w-md h-[90vh] rounded-t-3xl animate-slide-up flex flex-col text-[#4a4238] modal-content" @click.stop><div class="p-6 font-bold text-lg border-b border-[#4a4238]/10">Add Expense</div><div class="flex-1 overflow-y-auto p-6 pb-40"><div class="flex gap-3 mb-6"><button v-for="p in payers" :key="p" @click="newItem.payer=p" class="flex-1 py-4 rounded-xl border font-bold text-sm transition-colors" :class="newItem.payer===p?(p==='TszLok'?'bg-[#91867f] text-white border-transparent':'bg-[#726251] text-white border-transparent'):'border-[#4a4238]/30 text-[#4a4238]/60'">{{ p }}</button></div><div class="space-y-6"><div><label class="block text-xs font-bold opacity-60 mb-2">Item Name</label><input v-model="newItem.name" class="w-full bg-white p-5 rounded-2xl font-bold border-2 border-transparent text-[#4a4238] placeholder-[#4a4238]/30 focus:border-[#726251] outline-none text-lg"></div><div><label class="block text-xs font-bold opacity-60 mb-2">Price (¥)</label><input v-model.number="newItem.price" type="number" class="w-full bg-white p-5 rounded-2xl font-bold border-2 border-transparent text-[#4a4238] placeholder-[#4a4238]/30 focus:border-[#726251] outline-none text-lg"><div v-if="newItem.price" class="text-right mt-2 font-mono font-bold text-[#4a4238]/60">≈ HKD ${{ (newItem.price * currencyRate).toFixed(1) }}</div></div></div><div class="flex gap-3 mt-10"><button @click="showBudgetInput=false" class="flex-1 py-4 font-bold text-[#4a4238]/50 bg-black/5 rounded-2xl">Cancel</button><button @click="addItem" class="flex-1 py-4 bg-[#70808f] text-white rounded-2xl font-bold shadow-lg text-lg">Save</button></div></div></div></div>
    
    <div v-if="showWishlistInput" class="modal-layer flex items-end justify-center">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" @click="showWishlistInput=false"></div>
        <div class="bg-[#c5b59d] w-full max-w-md h-[90vh] rounded-t-3xl animate-slide-up flex flex-col text-[#4a4238] modal-content" @click.stop>
            <div class="p-6 font-bold text-lg border-b border-[#4a4238]/10">Add Wishlist</div>
            <div class="flex-1 overflow-y-auto p-6 pb-40">
                <div class="mb-6 relative w-full h-48 bg-white/30 border-2 border-dashed border-[#4a4238]/20 rounded-2xl flex flex-col items-center justify-center overflow-hidden">
                    <div v-if="newWishItem.image" class="w-full h-full relative">
                        <img :src="newWishItem.image" class="w-full h-full object-contain bg-black/10">
                        <button @click="newWishItem.image=null" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-times"></i></button>
                    </div>
                    <label v-else class="w-full h-full flex flex-col items-center justify-center cursor-pointer hover:bg-white/50 transition-colors">
                        <i class="fas fa-camera text-3xl mb-2 opacity-50"></i>
                        <span class="text-xs font-bold opacity-50">Select Photo (Album)</span>
                        <input type="file" accept="image/*" @change="handleImageUpload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    </label>
                </div>
                <div class="space-y-6"><div><label class="block text-xs font-bold opacity-60 mb-2">Item Name</label><input v-model="newWishItem.name" class="w-full bg-white p-5 rounded-2xl font-bold border-2 border-transparent text-[#4a4238] outline-none focus:border-[#726251] text-lg"></div><div><label class="block text-xs font-bold opacity-60 mb-2">Price (¥)</label><input v-model.number="newWishItem.price" type="number" class="w-full bg-white p-5 rounded-2xl font-bold border-2 border-transparent text-[#4a4238] outline-none focus:border-[#726251] text-lg"><div v-if="newWishItem.price" class="text-right mt-2 font-mono font-bold text-[#4a4238]/60">≈ HKD ${{ (newWishItem.price * currencyRate).toFixed(1) }}</div></div></div>
                <div class="flex gap-3 mt-10"><button @click="showWishlistInput=false" class="flex-1 py-4 font-bold text-[#4a4238]/50 bg-black/5 rounded-2xl">Cancel</button><button @click="addWishlist" class="flex-1 py-4 bg-[#70808f] text-white rounded-2xl font-bold shadow-lg text-lg">Add</button></div>
            </div>
        </div>
    </div>

    <div v-if="detailModal.show" class="modal-layer flex items-end justify-center"><div class="absolute inset-0 bg-black/80 backdrop-blur-sm" @click="detailModal.show=false"></div><div class="bg-[#c5b59d] w-full max-w-md rounded-t-3xl p-6 relative animate-slide-up max-h-[85vh] overflow-y-auto text-[#4a4238] modal-content" @click.stop><div class="w-12 h-1 bg-[#4a4238]/20 rounded-full mx-auto mb-6"></div><div v-if="detailModal.data.isTicket"><span class="px-3 py-1 rounded-lg text-xs font-bold uppercase" :class="getMethodBadge(detailModal.data.method)">{{ getMethodLabel(detailModal.data.method) }}</span><h2 class="text-2xl font-black mt-3 mb-2 font-mincho">{{ detailModal.data.title }}</h2><div class="bg-white/40 p-4 rounded-xl mb-4 shadow-sm"><div class="text-[10px] font-bold opacity-50 uppercase tracking-widest mb-1">地點 / 詳細資訊</div><div class="font-bold mb-1">{{ detailModal.data.location }}</div><div v-if="detailModal.data.desc" class="text-xs opacity-70 font-mono">{{ detailModal.data.desc }}</div><div class="mt-3 flex gap-2"><a v-if="detailModal.data.method === 'online' && detailModal.data.url" :href="detailModal.data.url" target="_blank" class="flex-1 py-3 bg-[#34a853] text-white text-center rounded-xl font-bold shadow-md active:scale-95 transition-transform text-sm"><i class="fas fa-external-link-alt mr-2"></i>預約網站</a><a v-if="detailModal.data.pdfLink" :href="detailModal.data.pdfLink" target="_blank" class="flex-1 py-3 bg-[#70808f] text-white text-center rounded-xl font-bold shadow-md active:scale-95 transition-transform text-sm"><i class="fas fa-file-pdf mr-2"></i>車票 PDF</a></div></div><div class="space-y-4"><div v-if="detailModal.data.guide.steps"><h4 class="text-xs font-bold opacity-60 uppercase tracking-widest mb-2">操作步驟</h4><ul class="list-decimal pl-5 space-y-2 text-sm font-bold opacity-90"><li v-for="step in detailModal.data.guide.steps">{{ step }}</li></ul></div><div v-if="detailModal.data.guide.reminder" class="bg-red-400/10 p-4 rounded-xl border-l-4 border-red-500 text-sm font-bold text-red-900"><i class="fas fa-exclamation-triangle mr-2"></i>{{ detailModal.data.guide.reminder }}</div></div></div><div v-else><span class="px-3 py-1 bg-[#70808f] text-white rounded-lg text-xs font-bold uppercase">{{ detailModal.data.typeLabel }}</span><h2 class="text-2xl font-black mt-3 mb-2 font-mincho">{{ detailModal.data.name }}</h2><div class="text-sm font-bold opacity-60 mb-6 flex items-center"><i class="far fa-clock mr-2"></i> {{ detailModal.data.time }}</div><div class="space-y-6 text-sm leading-relaxed"><div v-if="detailModal.data.desc"><h4 class="text-xs font-bold opacity-50 uppercase tracking-widest mb-2">Description</h4><p class="font-bold whitespace-pre-line">{{ detailModal.data.desc }}</p></div><div v-if="detailModal.data.strategy" class="bg-[#726251]/10 p-5 rounded-2xl border-l-4 border-[#726251]"><h4 class="text-xs font-bold uppercase tracking-widest mb-3 flex items-center"><i class="fas fa-chess-knight mr-2"></i>攻略 Strategy</h4><div class="font-bold whitespace-pre-line">{{ detailModal.data.strategy }}</div></div></div><div class="mt-6 space-y-3"><a v-if="detailModal.data.ticketLink" :href="detailModal.data.ticketLink" target="_blank" class="block w-full py-4 bg-[#726251] text-white text-center rounded-2xl font-bold shadow-lg">View Ticket</a><a v-if="detailModal.data.hotelLink" :href="detailModal.data.hotelLink" target="_blank" class="block w-full py-4 bg-[#91867f] text-white text-center rounded-2xl font-bold shadow-lg">View Hotel Booking</a></div><div class="h-6"></div><button @click="openMap(detailModal.data.name)" class="w-full py-4 bg-white text-[#4a4238] rounded-2xl font-bold shadow-lg">Open Map</button></div></div></div>

</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, doc, onSnapshot, setDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    // FIREBASE CONFIG (Your correct keys)
    const firebaseConfig = {
        apiKey: "AIzaSyCDOiAGPDY7Jd7ysg1fapFnCdidwGE66q8",
        authDomain: "nagoya-2026-361a0.firebaseapp.com",
        projectId: "nagoya-2026-361a0",
        storageBucket: "nagoya-2026-361a0.firebasestorage.app",
        messagingSenderId: "156812601167",
        appId: "1:156812601167:web:852ed3f4f431f7506cc73a",
        measurementId: "G-Z0NV8048TJ"
    };

    window.onerror = function(msg, url, line) {
        document.getElementById('app-error').style.display = 'block';
        document.getElementById('error-msg').innerText = msg;
        return false;
    };

    let db;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    } catch (e) { console.warn("Firebase Init Error", e); }

    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            const currentView = ref('itinerary'); 
            const dayIndex = ref(0);
            const detailModal = ref({ show: false, data: {} });
            const walletMode = ref('expense');
            const budgetFilter = ref('All'); 
            const showBudgetInput = ref(false);
            const showWishlistInput = ref(false);
            const payers = ['TszLok', 'TszTung'];
            const newItem = ref({ name: '', price: '', payer: 'TszLok' });
            const newWishItem = ref({ name: '', price: '', image: null });
            const budgetList = ref([]);
            const wishlist = ref([]);
            const packingList = ref({
                handCarry: [{name: '個人證件 (身分證/護照/簽證)', checked: false}, {name: '登機證', checked: false}, {name: '銀包', checked: false}, {name: 'SIM卡', checked: false}, {name: '手機 & 充電', checked: false}, {name: '預約證明', checked: false}, {name: '口罩/消毒', checked: false}],
                tszLok: [{name: '外出衣物', checked: false}, {name: '睡衣褲', checked: false}, {name: '內衣褲 & 襪', checked: false}, {name: '外套', checked: false}, {name: '男士剃鬚', checked: false}, {name: '轉插 & 拖板', checked: false}, {name: '雨傘/雨衣', checked: false}, {name: '拖鞋', checked: false}, {name: '備用膠袋', checked: false}],
                tszTung: [{name: '外出衣物', checked: false}, {name: '睡衣褲', checked: false}, {name: '內衣褲 & 襪', checked: false}, {name: '外套', checked: false}, {name: '化妝品', checked: false}, {name: '護膚品', checked: false}, {name: '洗面/洗髮', checked: false}, {name: '頭髮定型', checked: false}, {name: '梳 & 風筒', checked: false}, {name: '隱形眼鏡', checked: false}, {name: '女性護理', checked: false}, {name: '毛巾', checked: false}, {name: '公仔', checked: false}, {name: '熱水煲', checked: false}]
            });
            const currencyRate = ref(0.052);
            const calcExpression = ref('');
            const calcResult = ref('0');
            const syncStatus = ref('Connecting...');
            const syncColor = ref('bg-yellow-400');
            const tripDocId = "nagoya_v60_7"; 

            // FETCH REAL TIME RATE
            const fetchRate = async () => {
                try {
                    const res = await fetch('https://api.frankfurter.dev/v1/latest?from=JPY&to=HKD');
                    const data = await res.json();
                    if(data && data.rates && data.rates.HKD) {
                        currencyRate.value = data.rates.HKD;
                    }
                } catch(e) {
                    console.log("Using default rate");
                }
            };
            onMounted(() => { fetchRate(); });

            // HELPER FUNCTIONS (ALL RESTORED)
            const getTypeColor = (t) => ({food:'border-[#726251] bg-[#c5b59d]', transport:'border-[#70808f] bg-[#c5b59d]', stay:'border-[#91867f] bg-[#c5b59d]', spot:'border-[#4a4238] bg-[#c5b59d]'}[t]||'border-gray-400');
            const getMethodClass = (m) => ({ 'method-online': m==='online', 'method-onsite': m==='onsite', 'method-mobile': m==='mobile' }[m]);
            const getMethodBadge = (m) => ({ 'bg-[#e6f4ea] text-[#1e4620]': m==='online', 'bg-[#fef7e0] text-[#5f370e]': m==='onsite', 'bg-[#f1f3f4] text-[#3c4043]': m==='mobile' }[m]);
            const getMethodLabel = (m) => ({ online:'線上預約', onsite:'現場購買', mobile:'數位支付' }[m]);

            // SYNC
            onSnapshot(doc(db, "trips", tripDocId), (doc) => {
                syncStatus.value = "Live"; syncColor.value = "bg-green-400";
                if (doc.exists()) {
                    const data = doc.data();
                    if(data.budgetList) budgetList.value = data.budgetList;
                    if(data.wishlist) wishlist.value = data.wishlist;
                    if(data.packingList) packingList.value = data.packingList;
                }
            }, (error) => { console.error(error); syncStatus.value = "Offline"; syncColor.value = "bg-red-500"; });

            const saveData = async () => {
                syncStatus.value = "Saving..."; syncColor.value = "bg-blue-400 animate-pulse";
                try {
                    await setDoc(doc(db, "trips", tripDocId), { budgetList: budgetList.value, wishlist: wishlist.value, packingList: packingList.value }, { merge: true });
                    setTimeout(() => { syncStatus.value = "Live"; syncColor.value = "bg-green-400"; }, 500);
                } catch (e) { syncStatus.value = "Error"; syncColor.value = "bg-red-500"; }
            };
            watch(budgetList, saveData, { deep: true });
            watch(wishlist, saveData, { deep: true });
            const syncPacking = () => saveData();

            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX = 500; 
                        const scale = MAX / img.width;
                        if (scale < 1) { canvas.width = MAX; canvas.height = img.height * scale; } else { canvas.width = img.width; canvas.height = img.height; }
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        newWishItem.value.image = canvas.toDataURL('image/jpeg', 0.5);
                    }
                }
            };

            const addItem = () => { if(newItem.value.name&&newItem.value.price){ budgetList.value.unshift({...newItem.value}); showBudgetInput.value=false; newItem.value={name:'',price:'',payer:'TszLok'}; }};
            const addWishlist = () => { if(newWishItem.value.name){ wishlist.value.unshift({...newWishItem.value}); newWishItem.value={name:'',price:'',image:null}; showWishlistInput.value=false; }};
            const deleteBudget = (item) => { const idx = budgetList.value.indexOf(item); if(idx>-1) budgetList.value.splice(idx,1); };
            const deleteWishlist = (idx) => wishlist.value.splice(idx, 1);
            const openDetail = (p) => { detailModal.value = { show:true, data:p }; };
            const openTicketDetail = (t) => { detailModal.value = { show:true, data: { ...t, isTicket: true } }; };
            const getTicketsByMethod = (m) => ticketList.value.filter(t => t.method === m);
            const openMap = (n) => window.open('https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(n + ' Japan'), '_blank');
            const isModalOpen = computed(() => showBudgetInput.value || showWishlistInput.value || detailModal.value.show);
            const now = ref(new Date());
            
            // FIXED COUNTDOWN (Detailed)
            const countdown = computed(() => { 
                const target = new Date(2026, 1, 25, 9, 0, 0);
                const diff = target - now.value;
                if (diff <= 0) return { days: 0, hours: '00', minutes: '00', seconds: '00' };
                return { 
                    days: Math.floor(diff / (1000 * 60 * 60 * 24)), 
                    hours: Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0'), 
                    minutes: Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0'),
                    seconds: Math.floor((diff % (1000 * 60)) / 1000).toString().padStart(2, '0')
                }; 
            });
            const tripProgress = computed(() => Math.min(100, Math.max(0, ((now.value - new Date(2026,1,3,9,0)) / (new Date(2026,1,25,9,0) - new Date(2026,1,3,9,0))) * 100)));
            const nowFormatted = computed(() => now.value.toLocaleDateString('en-GB', { month: 'numeric', day: 'numeric' }));
            setInterval(() => now.value = new Date(), 1000);

            const appendCalc = (c) => calcExpression.value += c;
            const clearCalc = () => { calcExpression.value=''; calcResult.value='0'; };
            const backspace = () => calcExpression.value = calcExpression.value.slice(0,-1);
            const calculate = () => { try { calcResult.value = new Function('return '+calcExpression.value)().toString(); } catch(e) { calcResult.value='Error'; } };
            const displayValue = computed(() => calcExpression.value || calcResult.value);
            const filteredBudgetList = computed(() => budgetFilter.value === 'All' ? budgetList.value : budgetList.value.filter(i => i.payer === budgetFilter.value));
            const filteredTotal = computed(() => filteredBudgetList.value.reduce((s,i)=>s+i.price,0));

            const weatherDB = [
                { date: "2/25", hourly: [{time:"14:00",temp:"8°",icon:"fas fa-cloud-sun"},{time:"16:00",temp:"7°",icon:"fas fa-cloud"},{time:"18:00",temp:"6°",icon:"fas fa-moon"},{time:"20:00",temp:"5°",icon:"fas fa-moon"}] },
                { date: "2/26", hourly: [{time:"09:00",temp:"7°",icon:"fas fa-sun"},{time:"12:00",temp:"11°",icon:"fas fa-sun"},{time:"15:00",temp:"10°",icon:"fas fa-cloud-sun"},{time:"18:00",temp:"7°",icon:"fas fa-moon"}] },
                { date: "2/27", hourly: [{time:"10:00",temp:"9°",icon:"fas fa-cloud"},{time:"13:00",temp:"12°",icon:"fas fa-cloud-sun"},{time:"16:00",temp:"10°",icon:"fas fa-cloud"},{time:"19:00",temp:"8°",icon:"fas fa-cloud-rain"}] },
                { date: "2/28", hourly: [{time:"09:00",temp:"2°",icon:"fas fa-snowflake"},{time:"12:00",temp:"3°",icon:"fas fa-snowflake"},{time:"15:00",temp:"1°",icon:"fas fa-snowflake"},{time:"18:00",temp:"-1°",icon:"fas fa-snowflake"}] },
                { date: "3/1", hourly: [{time:"09:00",temp:"-2°",icon:"fas fa-snowflake"},{time:"12:00",temp:"0°",icon:"fas fa-snowflake"},{time:"15:00",temp:"-1°",icon:"fas fa-cloud-meatball"},{time:"18:00",temp:"-4°",icon:"fas fa-snowflake"}] },
                { date: "3/2", hourly: [{time:"09:00",temp:"-5°",icon:"fas fa-snowflake"},{time:"12:00",temp:"-2°",icon:"fas fa-sun"},{time:"15:00",temp:"-3°",icon:"fas fa-cloud-sun"},{time:"18:00",temp:"-6°",icon:"fas fa-moon"}] },
                { date: "3/3", hourly: [{time:"08:00",temp:"4°",icon:"fas fa-cloud-sun"},{time:"12:00",temp:"9°",icon:"fas fa-sun"},{time:"16:00",temp:"8°",icon:"fas fa-cloud-sun"},{time:"20:00",temp:"6°",icon:"fas fa-moon"}] }
            ];
            const currentDayWeather = computed(() => weatherDB[dayIndex.value]?.hourly || []);
            const keyLabels = { handCarry: 'Hand Carry', tszLok: 'TszLok (Boy)', tszTung: 'TszTung (Girl)' };

            // TICKET DATA (UPDATED WITH NEW SCHEDULE)
            const ticketList = ref([
                { 
                    date: "2/25 & 3/3", day: "Day 1, 7", title: "名鐵 μ-Sky (往返機場)", route: "機場 ↔ 名古屋", price: "¥1,430", method: "onsite", location: "機場/名鐵車站", 
                    guide: { 
                        steps: ["抵達名鐵機場站：走出機場入境大廳後，跟著「Train / Meitetsu Line」標示走。", "找到藍色或紅色售票機：選擇「μ-ticket」或「Limited Express」選項。", "劃位付款：前往「Nagoya」，選擇2人，選位 (可選連號)。", "可用現金、信用卡或 IC 卡。"], 
                        reminder: "一定要拿兩張票（乘車券+座位券）才能進站！" 
                    } 
                },
                { date: "2/26", day: "Day 2", title: "吉卜力交通", route: "市區 ↔ 吉卜力", price: "約 ¥1,340", method: "mobile", location: "Apple Wallet", guide: { steps: ["用 iPhone 交通卡。", "Apple Pay 加值 ¥3000。", "直接感應閘門。"], reminder: "確認手機有電！" } },
                { date: "2/27", day: "Day 3", title: "地鐵 24 小時券", route: "市區觀光", price: "¥760", method: "onsite", location: "地鐵售票機", guide: { steps: ["找黃色售票機。", "選 'Value Tickets'。", "平日¥760 / 週末¥620。"], reminder: "第一次進站啟用。" } },
                
                // UPDATED: Nohi Bus 2/28
                { 
                    date: "2/28", day: "Day 4", title: "濃飛巴士 (去程)", route: "名古屋 → 高山", price: "¥6,000 (來回)", method: "online", location: "名鐵巴士中心", 
                    desc: "發車: 09:30 | 出示 Web Ticket", 
                    pdfLink: "ticket_228.pdf", 
                    guide: { steps: ["前往名鐵巴士中心(名古屋站) 3F。", "出示 Web Ticket 手機畫面。", "尋找往高山/白川鄉月台。"], reminder: "請提早 15 分鐘抵達。" } 
                },

                // UPDATED: Shirakawa Bus 3/1 (Outbound)
                { 
                    date: "3/1", day: "Day 5", title: "濃飛巴士 (白川鄉去程)", route: "高山 → 白川鄉", price: "¥2,800 (單程)", method: "online", location: "高山濃飛巴士中心", 
                    desc: "去程: 08:10 | 座位: 8A/8B",
                    pdfLink: "ticket_301.pdf", 
                    guide: { steps: ["前往高山站旁的巴士中心 4 號月台。", "出示 Email 電子票。", "座位 8A / 8B。"], reminder: "預約編號: 02062000931。請務必準時。" } 
                },

                // ADDED: Shirakawa Bus 3/1 (Return) - FROM PDF
                { 
                    date: "3/1", day: "Day 5", title: "濃飛巴士 (白川鄉回程)", route: "白川鄉 → 高山", price: "¥5,600 (2人)", method: "online", location: "白川鄉巴士總站", 
                    desc: "發車: 15:45 | 座位: 1C/1D",
                    pdfLink: "ticket301_back.pdf", 
                    guide: { steps: ["前往白川鄉巴士總站。", "出示電子車票 (手機 PDF)。", "尋找車號 01，座位 1C/1D。"], reminder: "預約編號: 02072000521。發車前請提早抵達。" } 
                },

                { date: "3/2", day: "Day 6", title: "奧飛驒 2 日套票", route: "巴士+纜車", price: "¥6,300", method: "onsite", location: "高山濃飛巴士中心", guide: { steps: ["去 JR 旁巴士中心。", "買 'Okuhida Value Ticket'。", "付現金。"], reminder: "弄丟不補發！包含新穗高纜車來回。" } },

                // UPDATED: Nohi Bus 3/3
                { 
                    date: "3/3", day: "Day 7", title: "濃飛巴士 (回程)", route: "高山 → 名古屋", price: "使用來回票", method: "online", location: "高山濃飛巴士中心", 
                    desc: "發車: 13:20",
                    pdfLink: "ticket_303.pdf", 
                    guide: { steps: ["前往高山濃飛巴士中心。", "出示來回票回程憑證。", "上車睡覺。"], reminder: "下車地點: 名鐵巴士中心。" } 
                }
            ]);

            const itinerary = ref([
                { day: 1, date_short: "2/25", date_en: "Wed", location: "Nagoya", places: [
                    { time: "14:30", name: "中部國際機場", type: "transport", typeLabel: "抵達", desc: "入境、領行李 (預計 1 小時)。", highlights: ["入境"], strategy: "出關後跟著「名鐵電車」藍色指標走，前往機場站。" }, 
                    { time: "15:30", name: "名鐵 μ-Sky", type: "transport", typeLabel: "移動", desc: "前往名古屋站。", highlights: ["指定席"], strategy: "購票：自動售票機選「μ-ticket」，目的地「Nagoya」。\n劃位：機器上選 2 位成人及連號座位。\n費用：¥1,430。" }, 
                    { time: "16:30", name: "西鐵酒店 Croom", type: "stay", typeLabel: "Check-in", desc: "久屋大通站 4 號出口。", bookingType: "hotel", hotelLink: "#", highlights: ["大浴場"], strategy: "位置：久屋大通站 4 號出口步行 1 分鐘。\nCheck-in 後稍作休息。" }, 
                    { time: "18:00", name: "Indo Ryori Kalash", type: "food", typeLabel: "晚餐", desc: "地鐵鶴舞線「杁中站」。", highlights: ["印度咖哩"], strategy: "這是您指定的特色餐廳。\n搭乘地鐵鶴舞線至杁中站。" }, 
                    { time: "20:00", name: "Oasis 21", type: "spot", typeLabel: "夜景", desc: "水的宇宙船。", highlights: ["電視塔"], strategy: "在酒店附近，建議上頂層拍攝名古屋電視塔夜景。" }
                ]},
                { day: 2, date_short: "2/26", date_en: "Thu", location: "Nagoya", places: [
                    { time: "09:00", name: "Konparu 榮店", type: "food", typeLabel: "早餐", desc: "名古屋炸蝦三明治。", highlights: ["炸蝦三明治"], strategy: "必吃名古屋招牌炸蝦三明治，可內用或外帶。" }, 
                    { time: "11:00", name: "吉卜力公園 (外部)", type: "spot", typeLabel: "拍照", desc: "愛・地球博紀念公園。", highlights: ["青春之丘"], strategy: "交通：搭乘地鐵轉 Linimo 線。\n先在外部園區拍照。" }, 
                    { time: "12:00", name: "吉卜力大倉庫", type: "spot", typeLabel: "重點", desc: "需依預約時間入場。", bookingType: "ticket", ticketLink: "#", highlights: ["名場面展"], strategy: "內部展覽豐富，建議預留 3-4 小時。\n不要遲到！" }, 
                    { time: "18:00", name: "榮區購物", type: "spot", typeLabel: "購物", desc: "Tsubame Bread。", highlights: ["紅豆吐司"], strategy: "採購著名的紅豆吐司。\n逛逛榮區商圈。" }, 
                    { time: "19:00", name: "蓬萊軒 (松坂屋)", type: "food", typeLabel: "晚餐", desc: "鰻魚飯三吃。", highlights: ["鰻魚飯"], strategy: "經典鰻魚飯三吃。\n建議提前到櫃檯抽號碼牌，再去逛街。" }, 
                    { time: "20:30", name: "HARBS 本店", type: "food", typeLabel: "甜點", desc: "水果千層蛋糕。", highlights: ["外帶"], strategy: "外帶招牌水果千層蛋糕回酒店享用。" }
                ]},
                { day: 3, date_short: "2/27", date_en: "Fri", location: "Nagoya", places: [
                    { time: "09:00", name: "Komeda's Coffee", type: "food", typeLabel: "早餐", desc: "點咖啡送吐司。", highlights: ["紅豆泥"], strategy: "名古屋特色早餐文化，點飲料送厚片吐司。" }, 
                    { time: "10:30", name: "名古屋港水族館", type: "spot", typeLabel: "景點", desc: "虎鯨與海豚表演。", highlights: ["虎鯨"], strategy: "重點觀看虎鯨與海豚表演（預定 2.5 小時）。" }, 
                    { time: "13:30", name: "矢場炸豬排", type: "food", typeLabel: "午餐", desc: "味噌豬排。", highlights: ["鐵板"], strategy: "品嚐道地的名古屋味噌豬排。" }, 
                    { time: "15:00", name: "大須商店街", type: "spot", typeLabel: "逛街", desc: "三輪神社。", highlights: ["兔子神社"], strategy: "參拜兔子神社，體驗熱鬧的商店街。" }, 
                    { time: "17:00", name: "Piyorin 小雞蛋糕", type: "food", typeLabel: "搶購", desc: "Café Gentiane。", highlights: ["挑戰"], strategy: "⚠️ 17:00 最後出爐時間！\n必須準時在名古屋站排隊。\n回飯店挑戰不倒塌。" }, 
                    { time: "17:40", name: "MUJI 名鐵百貨", type: "spot", typeLabel: "購物", desc: "生活雜貨。", highlights: ["旗艦店"], strategy: "逛生活雜貨補貨（預留 1.5 小時）。" }, 
                    { time: "19:30", name: "名古屋站周邊", type: "food", typeLabel: "晚餐", desc: "寬麵或雞翅。", highlights: ["手羽先"], strategy: "推薦驛釜寬麵或世界之山將雞翅。" }
                ]},
                { day: 4, date_short: "2/28", date_en: "Sat", location: "Takayama", places: [
                    { time: "09:30", name: "濃飛巴士", type: "transport", typeLabel: "移動", desc: "前往高山。", highlights: ["Web Ticket"], strategy: "名鐵巴士中心 3F 搭乘。\n上車出示 Web Ticket 手機畫面即可。\n費用：來回票每人 ¥6,000。" }, 
                    { time: "12:30", name: "高山東急 Stay", type: "stay", typeLabel: "寄放", desc: "步行 2 分鐘即達。", bookingType: "hotel", hotelLink: "#", highlights: ["近車站"], strategy: "先寄放行李。" }, 
                    { time: "13:00", name: "高山老街", type: "spot", typeLabel: "散策", desc: "三町通。", highlights: ["飛驒牛壽司"], strategy: "漫步高山老街，品嚐路邊攤飛驒牛美食。" }, 
                    { time: "15:00", name: "Check-in", type: "stay", typeLabel: "入住", desc: "高山東急 Stay。", highlights: ["休息"], strategy: "辦理入住手續，稍作休息。" }, 
                    { time: "18:00", name: "味藏天國", type: "food", typeLabel: "晚餐", desc: "飛驒牛燒肉。", highlights: ["A5飛驒牛"], strategy: "⚠️ 不能預約！\n請在 17:00 左右先去門口登記名字抽籤。" }
                ]},
                { day: 5, date_short: "3/1", date_en: "Sun", location: "Shirakawa", places: [
                    { time: "08:10", name: "濃飛巴士", type: "transport", typeLabel: "移動", desc: "前往白川鄉。", highlights: ["8A/8B"], strategy: "預約編號：02062000931，座位 8A/8B。\n高山巴士總站 4 號月台候車，出示 Email 電子票上車。" }, 
                    { time: "09:30", name: "城山天守閣", type: "spot", typeLabel: "展望台", desc: "俯瞰合掌村。", highlights: ["經典角度"], strategy: "趁早先搭接駁車上去拍照，避開中午人潮。" }, 
                    { time: "12:30", name: "Irori (いろり)", type: "food", typeLabel: "午餐", desc: "朴葉味噌燒。", highlights: ["傳統料理"], strategy: "品嚐傳統朴葉味噌燒。" }, 
                    { time: "13:30", name: "三小屋 (忠兵衛)", type: "spot", typeLabel: "景點", desc: "村子後方。", highlights: ["田園風光"], strategy: "散步到村子後方，拍攝最著名的三小屋風景。" }, 
                    { time: "14:15", name: "喫茶落人", type: "food", typeLabel: "甜點", desc: "紅豆湯無限喝。", highlights: ["圍爐裏"], strategy: "喝咖啡，享用圍爐裏烤紅豆湯。" }, 
                    { time: "15:45", name: "濃飛巴士", type: "transport", typeLabel: "移動", desc: "返回高山。", highlights: ["回程"], strategy: "時間：16:35 抵達高山。" }
                ]},
                { day: 6, date_short: "3/2", date_en: "Mon", location: "Okuhida", places: [
                    { time: "09:40", name: "濃飛巴士", type: "transport", typeLabel: "移動", desc: "前往新穗高。", highlights: ["套票"], strategy: "在高山巴士站購買「奧飛驒 2 日套票」(¥6,300)。" }, 
                    { time: "12:00", name: "新穗高山頂", type: "spot", typeLabel: "展望台", desc: "標高 2156m。", highlights: ["雪之迴廊"], strategy: "欣賞全景及雪之迴廊。" }, 
                    { time: "14:20", name: "平湯大瀑布", type: "spot", typeLabel: "步行攻略", desc: "雪地健行。", highlights: ["藍色冰瀑", "⚠️防滑鞋"], strategy: "路線：從平湯巴士總站出發，往瀑布方向走。\n地形：雪地微上坡，單程約 25 分鐘。\n⚠️ 裝備建議：務必穿著「防滑鞋」(雪靴或加裝冰爪)，因為雪地結冰非常滑！\n景點：高達 64 米的瀑布會結冰成漂亮的藍色，是冬季限定美景。" }, 
                    { time: "15:40", name: "平湯巴士站", type: "food", typeLabel: "休息", desc: "足湯與牛奶。", highlights: ["溫泉蛋"], strategy: "吃溫泉蛋、喝飛驒牛奶、享受免費足湯。" }, 
                    { time: "18:30", name: "丸明", type: "food", typeLabel: "晚餐", desc: "飛驒牛壽喜燒。", highlights: ["壽喜燒"], strategy: "高山著名飛驒牛餐廳。" }
                ]},
                { day: 7, date_short: "3/3", date_en: "Tue", location: "Airport", places: [
                    { time: "09:00", name: "宮川朝市", type: "spot", typeLabel: "市集", desc: "河邊早市。", highlights: ["伴手禮"], strategy: "最後採買當地農產品及工藝品。" }, 
                    { time: "12:00", name: "LE MIDI", type: "food", typeLabel: "午餐", desc: "南瓜布丁。", highlights: ["甜點"], strategy: "享用高山美食。" }, 
                    { time: "13:20", name: "濃飛巴士", type: "transport", typeLabel: "移動", desc: "前往名古屋。", highlights: ["回程"], strategy: "使用來回票回程。抵達名鐵巴士中心。" }, 
                    { time: "17:20", name: "名鐵 μ-Sky", type: "transport", typeLabel: "移動", desc: "前往機場。", highlights: ["NGO"], strategy: "在名鐵名古屋站售票機劃位付款 (¥1,430)。" }, 
                    { time: "21:00", name: "起飛返港", type: "transport", typeLabel: "離境", desc: "UO685。", bookingType: "flight", flightNo: "UO685", terminal: "T2", highlights: [], strategy: "滿載而歸！" }
                ]}
            ]);

            const tabs = [ { id: 'itinerary', label: 'Plan', icon: 'fas fa-map-marked-alt' }, { id: 'wallet', label: 'Wallet', icon: 'fas fa-wallet' }, { id: 'packing', label: 'Pack', icon: 'fas fa-suitcase' }, { id: 'reservations', label: 'Resv', icon: 'fas fa-ticket-alt' }, { id: 'reminders', label: 'Tips', icon: 'fas fa-lightbulb' }, { id: 'info', label: 'Calc', icon: 'fas fa-calculator' } ];

            return { currentView, dayIndex, itinerary, budgetList, packingList, newItem, showBudgetInput, detailModal, countdown, openDetail, openTicketDetail, addItem, deleteBudget, payers, tabs, keyLabels, walletMode, showWishlistInput, newWishItem, wishlist, handleImageUpload, addWishlist, deleteWishlist, currentDayWeather, budgetFilter, filteredBudgetList, filteredTotal, getTypeColor, tripProgress, nowFormatted, isModalOpen, 
                // Calc exports
                currencyRate, calcExpression, appendCalc, clearCalc, backspace, calculate, displayValue,
                // Resv & Utils (RESTORED HERE)
                ticketList, openTicketDetail, getMethodClass, getMethodBadge, getMethodLabel, getTicketsByMethod,
                // Cloud Status
                syncStatus, syncColor, saveData, syncPacking
            };
        }
    }).mount('#app');
</script>
</body>
</html>
